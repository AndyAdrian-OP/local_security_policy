$DEBUG = $false
$DEBUGFILE = "c:\test.txt"

If ($DEBUG) {
echo "Start..." >> $DEBUGFILE
}

$file = "secbackup.inf"
secedit /export /cfg $file /quiet

$Policy = "<%= @mapping['name'] %>"
$Lookup_Users = @()
<% @setting.each do |mapUser| -%>
If ($DEBUG) {
	echo "Adding User: <%= mapUser %>" >> $DEBUGFILE
}
	$Lookup_Users += "<%= mapUser %>"
<% end -%>	

If ($DEBUG) {
	echo "Policy: $Policy" >> $DEBUGFILE
	echo "Lookup Users: $Lookup_Users" >> $DEBUGFILE
}

$Users = wmic useraccount get "name,sid" /format:csv
$Groups = wmic group get "name,sid" /format:csv
$AllAccounts = $Users + $Groups

$Name = @("")
$Sid = @("")

foreach ($line in $AllAccounts)
{
	if ($line.trim() -ne "") {
		$tmpline = $line.trim() -split "," 
		$Name += $tmpline[1]
		$Sid += $tmpline[2]
	}
}

$Lookup_Sids = @()
$PrivString = ""
foreach ($lookup in $Lookup_Users) {
	$Where = [array]::IndexOf($Name, $lookup)
	$Lookup_Sids += $Sid[$Where]
}


#write $PrivString
$PrivLine = Select-String -Simple "$Policy" $file 
$PrivSettingLine = $PrivLine -split "= "
$PrivSetting = $PrivSettingLine[1].trim() -split ","

if ($Lookup_Users.Count -ne $PrivSetting.Count) {
	If ($DEBUG) {
		echo "Number of Users Different" >> $DEBUGFILE
	}
	exit 1
}

foreach ($Sid in $Lookup_Sids) {
	$SidIndex = [array]::IndexOf($PrivSetting,"*"+$Sid)
	if ($SidIndex -eq -1) {
	If ($DEBUG) {
		echo "Can't Find User" >> $DEBUGFILE
	}
		exit 1
	}	
}

If ($DEBUG) {
	echo "Exact Match" >> $DEBUGFILE
}
exit 0

del $file
